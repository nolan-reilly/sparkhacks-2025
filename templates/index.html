<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BizBets</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <!-- Nav bar -->
    <header class="flex row nav-bg mb-96">
      <nav class="container flex row space-between align-center">
        <div class="nav-icon">
          <img
            src="{{ url_for('static', filename='images/icon.png')}}"
            alt=""
          />
        </div>
        <div class="flex row gap-32">
          <button id="switchScreen" class="nav-btn">Inventory</button>
          <!-- <button id="inventoryBtn" class="nav-btn">Inventory</button> -->
          <button id="addToPotBtn" class="nav-btn">Add to Pot</button>
        </div>
      </nav>
    </header>

    <!-- Spin container -->
    <div id="spinContainer">
      <div class="container flex col align-center gap-32">
        <div id="crate-container" class="crate-container">
          <div class="slider-track" id="sliderTrack"></div>
          <div class="marker"></div>
        </div>

        <div id="closedCrate">
          <img
            src="{{ url_for('static', filename='images/crate.png') }}"
            alt="Crate Image"
          />
        </div>

        <form method="GET">
          <button id="openCrate" class="spin-btn">Spin</button>
        </form>
      </div>
    </div>

    <div id="wonContainer" style="display: none">
      <div class="container flex col align-center gap-32">
        <div>
          <div class="image-container-rarity">
            {% if business == 'The Restaurant' %}
            <img
              src="{{ url_for('static', filename='images/restaurant.png') }}"
              class="{{rarity}}-border-bottom"
              alt="The Restaurant"
            />

            {% elif business == 'The Flower Company' %}
            <img
              src="{{ url_for('static', filename='images/flower.png') }}"
              class="{{rarity}}-border-bottom"
              alt=""
            />

            {% elif business == 'Salon' %}
            <img
              src="{{ url_for('static', filename='images/salon.png') }}"
              class="{{rarity}}-border-bottom"
              alt=""
            />

            {% elif business == 'Coffee Cup' %}
            <img
              src="{{ url_for('static', filename='images/coffee-cup.png') }}"
              class="{{rarity}}-border-bottom"
              alt=""
            />

            {% elif business == 'Books Galore' %}
            <img
              src="{{ url_for('static', filename='images/book.png') }}"
              class="{{rarity}}-border-bottom"
              alt=""
            />

            {% else %}
            <img
              src="https://picsum.photos/200/300"
              class="{{rarity}}-border-bottom"
              alt="Default Business"
            />
            {% endif %}
          </div>
          <h1>Received {{ business }}: {{ rarity }} Discount {{ prize }}!</h1>
          <button id="returnHome" class="spin-btn">Return Home</button>
        </div>
      </div>
    </div>

    <div id="companyContainer"></div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/prizes.js')}}"></script>
    <script src="{{ url_for('static', filename='js/script2.js') }}"></script>

    <script>
      const items = [
        "static/images/book.png",
        "static/images/coffee-cup.png",
        "static/images/restaurant.png",
        "static/images/coffee-cup.png",
        "static/images/flower.png",
        "static/images/book.png",
        "static/images/restaurant.png",
        "static/images/salon.png",
        "static/images/restaurant.png",
        "static/images/coffee-cup.png",
        "static/images/flower.png",
        "static/images/salon.png",
        "static/images/coffee-cup.png",
        "static/images/book.png",
        "static/images/salon.png",
        "static/images/restaurant.png",
        "static/images/coffee-cup.png",
        "static/images/flower.png",
        "static/images/salon.png",
        "static/images/coffee-cup.png",
        "static/images/book.png",
        "static/images/book.png",
        "static/images/restaurant.png",
        "static/images/restaurant.png",
        "static/images/coffee-cup.png",
        "static/images/salon.png",
        "static/images/restaurant.png",
        "static/images/coffee-cup.png",
        "static/images/flower.png",
        "static/images/book.png",
        "static/images/restaurant.png",
        "static/images/salon.png",
        "static/images/restaurant.png",
        "static/images/coffee-cup.png",
        "static/images/flower.png",
        "static/images/salon.png",
        "static/images/coffee-cup.png",
        "static/images/book.png",
        "static/images/salon.png",
        "static/images/restaurant.png",
        "static/images/coffee-cup.png",
        "static/images/flower.png",
        "static/images/salon.png",
        "static/images/coffee-cup.png",
        "static/images/book.png",
        "static/images/book.png",
        "static/images/restaurant.png",
        "static/images/restaurant.png",
        "static/images/coffee-cup.png",
        "static/images/salon.png",
        "static/images/restaurant.png",
        "static/images/coffee-cup.png",
        "static/images/flower.png",
        "static/images/book.png",
        "static/images/coffee-cup.png",
        "static/images/restaurant.png",
        "{{image_path}}",
        "static/images/flower.png",
        "static/images/book.png",
        "static/images/restaurant.png",
        "static/images/salon.png",
        "static/images/restaurant.png",
        "static/images/coffee-cup.png",
        "static/images/flower.png",
        "static/images/salon.png",
        "static/images/coffee-cup.png",
        "static/images/book.png",
        "static/images/salon.png",
        "static/images/restaurant.png",
        "static/images/coffee-cup.png",
        "static/images/flower.png",
        "static/images/coffee-cup.png",
        "static/images/salon.png",
        "static/images/restaurant.png",
        "static/images/coffee-cup.png",
        "static/images/flower.png",
        "static/images/book.png",
      ];

      // Extra full cycles (rotations through the entire set) before deceleration.
      const extraCycles = 5;

      // Fixed target index (0-based) that the spin will always land on.
      const fixedIndex = 2; // Always land on the 3rd image

      // Animation durations (in milliseconds) for the two phases.
      const durationPhase1 = 6350; // Fast spin phase
      const durationPhase2 = 1000; // Deceleration phase

      // We'll calculate the overshoot (in pixels) later based on an imageâ€™s total width.
      let overshoot;

      // Nav Buttons
      const addToPotBtn = document.querySelector("#addToPotBtn");

      const sliderTrack = document.getElementById("sliderTrack");
      const crateContainer = document.querySelector("#crate-container");
      const openBtn = document.getElementById("openCrate");
      const spinContainer = document.querySelector("#spinContainer");
      const wonImage = document.querySelector("#wonImage");
      const closedCrate = document.querySelector("#closedCrate");
      const wonContainer = document.querySelector("#wonContainer");

      const scrollSound = new Audio("/static/sfx/scroll.mp3");
      scrollSound.volume = 0.25;

      function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      // Populate the slider track with 3 copies of the items.
      // The middle copy is used to allow precise alignment.
      function populateTrack() {
        sliderTrack.innerHTML = "";
        for (let copy = 0; copy < 3; copy++) {
          items.forEach((src, i) => {
            const img = document.createElement("img");

            const integer = randomInt(0, 100);

            switch (true) {
              case integer >= 0 && integer <= 50:
                img.classList.add("common-border-bottom");
                break;
              case integer >= 51 && integer <= 70:
                img.classList.add("uncommon-border-bottom");
                break;
              case integer >= 71 && integer <= 85:
                img.classList.add("rare-border-bottom");
                break;
              case integer >= 86 && integer <= 95:
                img.classList.add("epic-border-bottom");
                break;
              case integer >= 96 && integer <= 100:
                img.classList.add("legendary-border-bottom");
                break;
            }

            img.src = src;
            img.alt = `Item ${i + 1}`;

            sliderTrack.appendChild(img);
          });
        }
      }
      populateTrack();

      // Calculate each image's total width (image width + left/right margins).
      const firstImg = sliderTrack.querySelector("img");
      const computedStyle = window.getComputedStyle(firstImg);
      const imgWidth = parseFloat(computedStyle.width);
      const marginLeft = parseFloat(computedStyle.marginLeft);
      const marginRight = parseFloat(computedStyle.marginRight);
      const itemTotalWidth = imgWidth + marginLeft + marginRight;
      // Set overshoot to one full item width (adjust as needed)
      overshoot = itemTotalWidth;

      // Number of items in one copy
      const originalCount = items.length;

      // The initial transform so that the entire middle copy is in view.
      const initialTranslateX = -originalCount * itemTotalWidth;
      sliderTrack.style.transform = `translateX(${initialTranslateX}px)`;

      // This function starts the full animation when the button is clicked.
      function startCrateAnimation() {
        // Display and hide certain containers on start animation
        spinContainer.style.display = "block";
        openBtn.disabled = true;

        scrollSound.play();

        // Reset to the initial position immediately
        sliderTrack.style.transition = "none";
        sliderTrack.style.transform = `translateX(${initialTranslateX}px)`;
        sliderTrack.offsetWidth; // Force reflow to make the reset is applied

        // Calculate some key positions
        const containerWidth = crateContainer.offsetWidth;
        const containerCenter = containerWidth / 2;
        const imageCenterOffset = itemTotalWidth / 2;

        // Centers the target image after spinning extra full cycles
        const finalTranslateX =
          containerCenter -
          ((originalCount + fixedIndex) * itemTotalWidth + imageCenterOffset) -
          extraCycles * originalCount * itemTotalWidth;

        // For phase 1, we want to quickly cover most of the distance.
        // We set an intermediate position a bit short of the final position.
        const intermediateTranslateX = finalTranslateX + overshoot;

        // Start Phase 1 of animation
        sliderTrack.style.transition = `transform ${durationPhase1}ms cubic-bezier(0.25, 0.1, 0.25, 1)`;
        sliderTrack.addEventListener("transitionend", phase1EndHandler);
        sliderTrack.style.transform = `translateX(${intermediateTranslateX}px)`;

        // When phase 1 ends, move to phase 2 of the animation
        function phase1EndHandler(e) {
          if (e.propertyName !== "transform") return;
          sliderTrack.removeEventListener("transitionend", phase1EndHandler);
          startPhase2(finalTranslateX);
        }
      }

      function startPhase2(finalTranslateX) {
        // Ease-out for a smooth slowdown
        sliderTrack.style.transition = `transform ${durationPhase2}ms ease-out`;
        sliderTrack.addEventListener("transitionend", phase2EndHandler);
        sliderTrack.style.transform = `translateX(${finalTranslateX}px)`;

        function phase2EndHandler(e) {
          if (e.propertyName !== "transform") return;
          sliderTrack.removeEventListener("transitionend", phase2EndHandler);

          // Play Fortnite loot box sound after animation finishes
          const finishSound = new Audio("/static/sfx/open.mp3");
          finishSound.volume = 0.25;
          finishSound.play();

          // Display and Redisplay certain containers after animation finish
          spinContainer.style.display = "none";
          wonContainer.style.display = "block";

          openBtn.disabled = false; // Enable button after the animation finishes
        }
      }

      function returnHomepage() {
        spinContainer.style.display = "block";
        wonContainer.style.display = "none";
        window.location.reload();
      }

      openBtn.addEventListener("click", startCrateAnimation);
      wonContainer.addEventListener("click", returnHomepage);

      document
        .getElementById("openCrate")
        .addEventListener("click", function () {
          fetch("/run-script", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          }) // Call Flask route
            .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                document.getElementById("scriptOutput").innerText =
                  "Error: " + data.error;
              } else {
                document.getElementById("scriptOutput").innerText =
                  "Output: " + data.output;
              }
            })
            .catch((error) => console.error("Error:", error));
        });

      document
        .getElementById("switchScreen")
        .addEventListener("click", function () {
          window.location.href = "/home-base"; // Make sure this matches the route in app.py
        });
    </script>
  </body>
</html>
